(function(a){a.feedback=function(b){var e=a.extend({ajaxURL:"",postBrowserInfo:true,postHTML:true,postURL:true,requireContactInfo:true,proxy:undefined,letterRendering:false,initButtonText:"Send feedback",strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:10,lineJoin:"bevel",lineWidth:3,html2canvasURL:"html2canvas.js",feedbackButton:".feedback-btn",showDescriptionModal:true,isDraggable:true,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Description</h3><h3 class="feedback-additional">Additional info</h3><div id="feedback-additional-none"><span>None</span></div><div id="feedback-browser-info"><label title="The browser name, version, and list of installed plugins will be sent to server"><input type="checkbox" name="input-browser-info" id="input-browser-info" checked /> Browser Info</label></div><div id="feedback-page-info"><label title="the page URL you are viewing will be sent to server"><input type="checkbox" name="input-page-info" id="input-page-info" checked /> Page Info</label></div><div id="feedback-page-structure"><label title="the html source code of the page you are viewing will be sent to server"><input type="checkbox" name="input-page-structure" id="input-page-structure" checked /> Page Structure</label></div></div></div><div id="feedback-overview-screenshot"><h3>Screenshot</h3></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error"></div><div class="feedback-wizard-close"></div></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p><p>We cannot respond individually to every one, but we will use your comments as we strive to improve your experience.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:true,highlightElement:true,initialBox:false},b);var i=!!window.HTMLCanvasElement;var f=e.feedbackButton==".feedback-btn";var d=false;if(i){if(f){a("body").append('<button class="feedback-btn feedback-btn-gray">'+e.initButtonText+"</button>")}a(document).on("click",e.feedbackButton,function(){if(f){a(this).hide()}if(!d){a.getScript(e.html2canvasURL,function(){d=true})}var j=false,l="",m=a(document).height(),q=a(document).width(),n='<div id="feedback-module">';if(e.initialBox){n+=e.tpl.description}n+=e.tpl.highlighter+e.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>';a("body").append(n);moduleStyle={position:"absolute",left:"0px",top:"0px"};canvasAttr={width:q,height:m};a("#feedback-module").css(moduleStyle);a("#feedback-canvas").attr(canvasAttr).css("z-index","30000");if(!e.initialBox){a("#feedback-highlighter-back").remove();j=true;a("#feedback-canvas").css("cursor","crosshair");a("#feedback-helpers").show();a("#feedback-welcome").hide();a("#feedback-highlighter").show()}if(e.isDraggable){a("#feedback-highlighter").on("mousedown",function(x){var v=a(this).addClass("feedback-draggable"),s=v.outerHeight(),w=v.outerWidth(),t=v.offset().top+s-x.pageY,u=v.offset().left+w-x.pageX;v.css("z-index",40000).parents().on("mousemove",function(y){_top=y.pageY+t-s;_left=y.pageX+u-w;_bottom=s-y.pageY;_right=w-y.pageX;if(_left<0){_left=0}if(_top<0){_top=0}if(_right>a(window).width()){_left=a(window).width()-w}if(_left>a(window).width()-w){_left=a(window).width()-w}if(_bottom>a(document).height()){_top=a(document).height()-s}if(_top>a(document).height()-s){_top=a(document).height()-s}a(".feedback-draggable").offset({top:_top,left:_left}).on("mouseup",function(){a(this).removeClass("feedback-draggable")})});x.preventDefault()}).on("mouseup",function(){a(this).removeClass("feedback-draggable");a(this).parents().off("mousemove mousedown")})}var r=a("#feedback-canvas")[0].getContext("2d");r.fillStyle="rgba(102,102,102,0.5)";r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());rect={};drag=false;highlight=1,post={};if(e.postBrowserInfo){post.browser={};post.browser.appCodeName=navigator.appCodeName;post.browser.appName=navigator.appName;post.browser.appVersion=navigator.appVersion;post.browser.cookieEnabled=navigator.cookieEnabled;post.browser.onLine=navigator.onLine;post.browser.platform=navigator.platform;post.browser.userAgent=navigator.userAgent;post.browser.plugins=[];a.each(navigator.plugins,function(s){post.browser.plugins.push(navigator.plugins[s].name)});a("#feedback-browser-info").show()}if(e.postURL){post.url=document.URL;a("#feedback-page-info").show()}if(e.postHTML){post.html=a("html").html();a("#feedback-page-structure").show()}if(!e.postBrowserInfo&&!e.postURL&&!e.postHTML){a("#feedback-additional-none").show()}a(document).on("mousedown","#feedback-canvas",function(s){if(j){rect.startX=s.pageX-a(this).offset().left;rect.startY=s.pageY-a(this).offset().top;rect.w=0;rect.h=0;drag=true}});a(document).on("mouseup",function(){if(j){drag=false;var t=rect.startY,s=rect.startX,u=rect.w,v=rect.h;dtype="highlight";if(u==0||v==0){return}if(u<0){s+=u;u*=-1}if(v<0){t+=v;v*=-1}if(t+v>a(document).height()){v=a(document).height()-t}if(s+u>a(document).width()){u=a(document).width()-s}if(highlight==0){dtype="blackout"}a("#feedback-helpers").append('<div class="feedback-helper" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+t+"px;left:"+s+"px;width:"+u+"px;height:"+v+'px;z-index:30000;"></div>');h(r);rect.w=0}});a(document).on("mousemove",function(s){if(j&&drag){a("#feedback-highlighter").css("cursor","default");rect.w=(s.pageX-a("#feedback-canvas").offset().left)-rect.startX;rect.h=(s.pageY-a("#feedback-canvas").offset().top)-rect.startY;r.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());r.fillStyle="rgba(102,102,102,0.5)";r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){c(r,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});if(highlight==1){c(r,rect.startX,rect.startY,rect.w,rect.h);r.clearRect(rect.startX,rect.startY,rect.w,rect.h)}a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){r.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="blackout"){r.fillStyle="rgba(0,0,0,1)";r.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});if(highlight==0){r.fillStyle="rgba(0,0,0,0.5)";r.fillRect(rect.startX,rect.startY,rect.w,rect.h)}}});if(e.highlightElement){var k=[],p=[],o=0;a(document).on("mousemove click","#feedback-canvas",function(x){if(j){h(r);p=[];a("#feedback-canvas").css("cursor","crosshair");a("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){if(a(this).attr("data-highlighted")==="true"){return}if(x.pageX>a(this).offset().left&&x.pageX<a(this).offset().left+a(this).width()&&x.pageY>a(this).offset().top+parseInt(a(this).css("padding-top"),10)&&x.pageY<a(this).offset().top+a(this).height()+parseInt(a(this).css("padding-top"),10)){p.push(a(this))}});var s=p[p.length-1];if(s&&!drag){a("#feedback-canvas").css("cursor","pointer");var u=s.offset().left-2,t=s.offset().top-2,v=s.width()+parseInt(s.css("padding-left"),10)+parseInt(s.css("padding-right"),10)+6,w=s.height()+parseInt(s.css("padding-top"),10)+parseInt(s.css("padding-bottom"),10)+6;if(highlight==1){c(r,u,t,v,w);r.clearRect(u,t,v,w);dtype="highlight"}a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){r.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});if(highlight==0){dtype="blackout";r.fillStyle="rgba(0,0,0,0.5)";r.fillRect(u,t,v,w)}a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="blackout"){r.fillStyle="rgba(0,0,0,1)";r.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});if(x.type=="click"&&x.pageX==rect.startX&&x.pageY==rect.startY){a("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+o+'" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+t+"px;left:"+u+"px;width:"+v+"px;height:"+w+'px;z-index:30000;"></div>');k.push(o);++o;h(r)}}}})}a(document).on("mouseleave","body,#feedback-canvas",function(){h(r)});a(document).on("mouseenter",".feedback-helper",function(){h(r)});a(document).on("click","#feedback-welcome-next",function(){if(a("#feedback-note").val().length>0){j=true;a("#feedback-canvas").css("cursor","crosshair");a("#feedback-helpers").show();a("#feedback-welcome").hide();a("#feedback-highlighter").show()}else{a("#feedback-welcome-error").show()}});a(document).on("mouseenter mouseleave",".feedback-helper",function(s){if(drag){return}rect.w=0;rect.h=0;if(s.type==="mouseenter"){a(this).css("z-index","30001");a(this).append('<div class="feedback-helper-inner" style="width:'+(a(this).width()-2)+"px;height:"+(a(this).height()-2)+'px;position:absolute;margin:1px;"></div>');a(this).append('<div id="feedback-close"></div>');a(this).find("#feedback-close").css({top:-1*(a(this).find("#feedback-close").height()/2)+"px",left:a(this).width()-(a(this).find("#feedback-close").width()/2)+"px"});if(a(this).attr("data-type")=="blackout"){r.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());r.fillStyle="rgba(102,102,102,0.5)";r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){c(r,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){r.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});r.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height());r.fillStyle="rgba(0,0,0,0.75)";r.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height());ignore=a(this).attr("data-time");a(".feedback-helper").each(function(){if(a(this).attr("data-time")==ignore){return true}if(a(this).attr("data-type")=="blackout"){r.fillStyle="rgba(0,0,0,1)";r.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}})}}else{a(this).css("z-index","30000");a(this).children().remove();if(a(this).attr("data-type")=="blackout"){h(r)}}});a(document).on("click","#feedback-close",function(){if(e.highlightElement&&a(this).parent().attr("data-highlight-id")){var s=a(this).parent().attr("data-highlight-id")}a(this).parent().remove();if(e.highlightElement&&s){a('[data-highlight-id="'+s+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id")}h(r)});a("#feedback-module").on("click",".feedback-wizard-close,.feedback-close-btn",function(){g()});a(document).on("keyup",function(s){if(s.keyCode==27){g()}});a(document).on("selectstart dragstart",document,function(s){s.preventDefault()});a(document).on("click","#feedback-highlighter-back",function(){j=false;a("#feedback-canvas").css("cursor","default");a("#feedback-helpers").hide();a("#feedback-highlighter").hide();a("#feedback-welcome-error").hide();a("#feedback-welcome").show()});a(document).on("mousedown",".feedback-sethighlight",function(){highlight=1;a(this).addClass("feedback-active");a(".feedback-setblackout").removeClass("feedback-active")});a(document).on("mousedown",".feedback-setblackout",function(){highlight=0;a(this).addClass("feedback-active");a(".feedback-sethighlight").removeClass("feedback-active")});a(document).on("click","#feedback-highlighter-next",function(){j=false;a("#feedback-canvas").css("cursor","default");var t=a(document).scrollTop(),s=a(window).height();a("#feedback-helpers").hide();a("#feedback-highlighter").hide();if(!e.screenshotStroke){h(r,false)}html2canvas(a("body"),{onrendered:function(u){if(!e.screenshotStroke){h(r)}_canvas=a('<canvas id="feedback-canvas-tmp" width="'+q+'" height="'+s+'"/>').hide().appendTo("body");_ctx=_canvas.get(0).getContext("2d");_ctx.drawImage(u,0,t,q,s,0,0,q,s);l=_canvas.get(0).toDataURL();a(document).scrollTop(t);post.img=l;e.onScreenshotTaken(post.img);if(e.showDescriptionModal){a("#feedback-canvas-tmp").remove();a("#feedback-overview").show();a("#feedback-overview-description-text>textarea").remove();a("#feedback-overview-screenshot>img").remove();a('<textarea id="feedback-overview-note" placeholder="Provide a brief description of the issue you are facing">'+a("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)");a("#feedback-overview-screenshot").append('<img class="feedback-screenshot" src="'+l+'" />');if(e.requireContactInfo){a('<h3>Contact Info</h3><input type="text" id="feedback-overview-contact" placeholder="Your email or phone number so that we can get back to you" />').insertAfter("#feedback-overview-note")}}else{a("#feedback-module").remove();g();_canvas.remove()}},proxy:e.proxy,letterRendering:e.letterRendering})});a(document).on("click","#feedback-overview-back",function(s){j=true;a("#feedback-canvas").css("cursor","crosshair");a("#feedback-overview").hide();a("#feedback-helpers").show();a("#feedback-highlighter").show();a("#feedback-overview-error").hide()});a(document).on("keyup","#feedback-note-tmp,#feedback-overview-note",function(t){var s;if(t.target.id==="feedback-note-tmp"){s=a("#feedback-note-tmp").val()}else{s=a("#feedback-overview-note").val();a("#feedback-note-tmp").val(s)}a("#feedback-note").val(s)});a(document).on("click","#feedback-submit",function(){j=false;if(e.requireContactInfo==true&&a("#feedback-overview-contact").val().length>0){post.contact=a("#feedback-overview-contact").val();if(a("#feedback-note").val().length>0){a("#feedback-submit-success,#feedback-submit-error").remove();a("#feedback-overview").hide();post.img=l;post.note=a("#feedback-note").val();a.ajax({url:e.ajaxURL,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(post),success:function(){a("#feedback-module").append(e.tpl.submitSuccess)},error:function(){a("#feedback-module").append(e.tpl.submitError)}})}else{a("#feedback-overview-error").text("Please enter a description.").show()}}else{a("#feedback-overview-error").text("Please enter your contact info.").show()}})})}function g(){canDraw=false;a(document).off("mouseenter mouseleave",".feedback-helper");a(document).off("mouseup keyup");a(document).off("mousedown",".feedback-setblackout");a(document).off("mousedown",".feedback-sethighlight");a(document).off("mousedown click","#feedback-close");a(document).off("mousedown","#feedback-canvas");a(document).off("click","#feedback-highlighter-next");a(document).off("click","#feedback-highlighter-back");a(document).off("click","#feedback-welcome-next");a(document).off("click","#feedback-overview-back");a(document).off("mouseleave","body");a(document).off("mouseenter",".feedback-helper");a(document).off("selectstart dragstart",document);a("#feedback-module").off("click",".feedback-wizard-close,.feedback-close-btn");a(document).off("click","#feedback-submit");if(e.highlightElement){a(document).off("click","#feedback-canvas");a(document).off("mousemove","#feedback-canvas")}a('[data-highlighted="true"]').removeAttr("data-highlight-id").removeAttr("data-highlighted");a("#feedback-module").remove();a(".feedback-btn").show();e.onClose.call(this)}function h(j,k){k=typeof k!=="undefined"?k:true;j.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());j.fillStyle="rgba(102,102,102,0.5)";j.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){if(k){c(j,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}}});a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="highlight"){j.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}});a(".feedback-helper").each(function(){if(a(this).attr("data-type")=="blackout"){j.fillStyle="rgba(0,0,0,1)";j.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}})}function c(l,j,n,k,m){l.strokeStyle=e.strokeStyle;l.shadowColor=e.shadowColor;l.shadowOffsetX=e.shadowOffsetX;l.shadowOffsetY=e.shadowOffsetY;l.shadowBlur=e.shadowBlur;l.lineJoin=e.lineJoin;l.lineWidth=e.lineWidth;l.strokeRect(j,n,k,m);l.shadowOffsetX=0;l.shadowOffsetY=0;l.shadowBlur=0;l.lineWidth=1}}}(jQuery));